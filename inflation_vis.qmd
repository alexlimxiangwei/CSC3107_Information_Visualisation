---
title: "inflation_vis"
format: html
editor: visual
---
# Imports and Packages
```{r}
library(readxl)
library(tidyverse)
library(pheatmap)
library(ggplot2)
library(scales)
```

# Data Import
```{r}

# Read in the wide data
wide_data <- read_csv("data/merged/filtered_wide_inflation_data.csv")

# Convert the data to a matrix format for pheatmap
inflation_matrix <- as.matrix(wide_data[, -1])  # Remove the first column (expenditure_category)
rownames(inflation_matrix) <- wide_data$expenditure_category  # Set the row names to the expenditure categories
print(inflation_matrix)
```


```{r}
# Plot the heatmap
pheatmap(inflation_matrix,
         cluster_rows = TRUE,
         cluster_cols = TRUE,
         show_rownames = TRUE,
         show_colnames = TRUE,
         main = "Inflation Rates for Selected Categories",
         fontsize_row = 10,
         fontsize_col = 8)
```

# Data Analysis
```{r}
# GGPlot implementatioin

# Making long
long_data <- wide_data %>%
  pivot_longer(cols = -expenditure_category, names_to = "date", values_to = "inflation_rate")

covid_data <- read_csv("data/raw/covid/WHO-COVID-19-global-data.csv")
# Summarize to a monthly level


covid_data <- covid_data |>
  filter(Country == "United States of America") |>
  select(Date_reported, New_cases) |>
  mutate(Date_reported = as.Date(Date_reported)) |>
  group_by(month = floor_date(Date_reported, "month")) |>
  summarise(total_cases = sum(New_cases, na.rm = TRUE)) |>
  mutate(prev_year_cases = lag(total_cases, n = 12),     
         pct_change = (total_cases - prev_year_cases) / prev_year_cases * 100) |>
  mutate(month = format(month, "%Y/%m")) |>
  # Normalize the pct_change values
  mutate(pct_change = (pct_change - min(pct_change, na.rm = TRUE)) / (max(pct_change, na.rm = TRUE) - min(pct_change, na.rm =TRUE)))


print(long_data)
print(covid_data)
```

# Improved Data Plot
```{r}
# Plot the inflation rates over time with heatmap
ggplot() +
  geom_tile(data=long_data, aes(x = date, y = expenditure_category, fill = inflation_rate),color = "white") +
  theme_minimal() +
  scale_fill_distiller(palette = "RdYlBu") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Inflation Rates for Selected Categories Over Time",
       x = "From 2019 to 2024",
       y = "Expenditure Category",
       fill = "Inflation Rate (%)")+
  theme(axis.text.x = element_blank())+
  geom_line(data = covid_data, aes(x = month, y = pct_change * 10, group = 1), color = "red", show.legend = TRUE) +
  scale_color_manual(values = c("COVID Data" = "red")) +
  guides(color = guide_legend(title = "COVID Data Legend", override.aes = list(shape = NA)))

```

```{r}

# Ensure the 'month' in covid_data is a factor for proper alignment with non-date format
covid_data <- covid_data |> mutate(month = as.factor(month))

# Create the plot
ggplot() +
  # Inflation rate tiles
  geom_tile(data = long_data, aes(x = date, y = expenditure_category, fill = inflation_rate), color = "white") +
  # COVID data line
  geom_line(data = covid_data, aes(x = month, y = pct_change * 10, group = 1, color = "COVID Data"), size = 1) +
  # Theme and formatting
  theme_minimal() +
  scale_fill_distiller(palette = "RdYlBu") +
  scale_color_manual(values = c("COVID Data" = "red")) +
  scale_x_discrete(breaks = levels(covid_data$month)[seq(1, length(levels(covid_data$month)), by = 3)]) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        axis.text.y = element_text(size = 10),
        legend.position = "bottom") +
  labs(title = "Inflation Rates for Selected Categories Over Time",
       x = "Date",
       y = "Expenditure Category",
       fill = "Inflation Rate (%)",
       color = "Data Type") +
  guides(color = guide_legend(title = "Legend", override.aes = list(linetype = c("solid"))))

```
